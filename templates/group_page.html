{% extends 'base.html' %}
{% block content %}

<div class = "row">
<section class = "col-xs-12">
  <div class = "row">
    <div class = "col-xs-12 col-sm-12 col-md-9">
      <h2>Welcome to {{ group.group_name}}</h2>

      <section>   
          {% if group.group_descrip %}
            <p data-linkify="this">{{ group.group_descrip }}</p>
          {% endif %}
          {% if user == group.admin_id %}
            <a href="/group_profile_form/{{ group.group_id }}">Update the group information</a>
          {% endif %}
          <hr>       
      </section>

      {% if patterns|length == 0 %}
        <section>
            <p>
              {% if group.group_image %}
                <img src= "/{{ group.group_image }}" width="80%">
              {% endif %} 
            </p>  
        </section>
      {% endif %}

     
        {% if patterns|length > 1 %}
        <section>
            <div id = "myChart" class = "pattern_poll">
              <canvas id = "pattern_bar_graph"></canvas>
            <div id = "barLegend" class="chart-legend"></div>
        </section>
        {% endif %}
      
      <hr>
      {% if patterns|length == 1 %}
        <section>
            <img src= "/{{ group.group_image }}" width="80%">
            <h3> This month we are working on {{ patterns[0].pattern_name }}</h3>
            <p>
              {% if patterns[0].pattern_pdf %}
                Click<a href="/{{ patterns[0].pattern_pdf }}" target="blank"> here </a> to download the pattern.<br> 
              {% endif %}
              {% if patterns[0].pattern_link %}
                Click <a href="{{ patterns[0].pattern_link }}" target="blank">here</a> to go to the pattern source.
              {% endif %} 
            </p>  
        </section>
      {% endif %}   

      {% if patterns|length > 1 %}
        <div class ="row">
          <section class = "col-lg-10 col-lg-offset-1">
            <div class="clock" style="margin:2em;"></div>
          </section>
        </div>
        <div id="final_vote_confirm">
          <div class="message"></div>
          <div class="votes_complete"> </div>
            <form id= "final_vote_form" action = "/final_vote/{{ group.group_id }}" method="POST">
            {% for pattern in patterns %}
              <label>{{ pattern.pattern_name}}</label>
              <button name="final_vote_submit" type="submit" value ="{{ pattern.pattern_id }}">Select</button>
            {% endfor %}
            </form>
        </div>
        <section style = "margin-left: 5%">
            <h3>Your vote counts!</h3>
            <p> Here are the choices for the group's pattern.</p>
            <div class = "row">
              <form id ="vote_form" action="/poll.json/<int:group_id>" method="POST" style= "margin-bottom:20px">
                  {% for pattern in patterns %}
                    <div class ="col-xs-12 col-sm-12 col-md-4">
                      <b> {{ pattern.pattern_name }} </b>
                      <br>
                      {% if pattern.pattern_pdf %}
                        Click<a href="/{{ pattern.pattern_pdf }}" target="blank"> here </a> to get the pdf pattern.<br> 
                      {% endif %}
                      {% if pattern.pattern_link %}
                        Click <a href="{{ pattern.pattern_link }}" target="blank">here</a> to go to the pattern source.<br>
                      {% endif %}
                      <input type="radio" class ="pattern_select" name="pattern_select" value="{{ pattern.pattern_id }}">
                    </div>
                  {% endfor %}
                  <input type="hidden" name="group_id" id="pattern_group" value="{{group.group_id}}">
                  <button id="vote_submit" type="submit">Vote!</button>
              </form>
            </div>
        </section>
      {% endif %}
      <div class ="row">
        <section class = "col-lg-10 col-lg-offset-1">
            <div>
            <h3> Comments:</h3>
           
                <form id="comment_form" action="/comment_add.json" method="POST" enctype="multipart/form-data">
                    Add a comment:
                    <input type="hidden" name="group_id" id="group_id" value="{{group.group_id}}">
                    <br>
                    <input type="text" name="comment_text" id="comment_text" placeholder="comment">
                    <br>Add a picture! <input type="file" id="comment_image" name="comment_image"><br>
                    
                    <button id="comment_submit" type="submit">Add your comment</button>
                </form>
                <br>
            </div>

            <div id="new_comment"></div>

            {% for comment in comments|sort(attribute="comment_id", reverse = True) %}
            <div>
                <img src="/{{ comment.user.user_photo }}" width="50">
                <h4>{{ comment.user.first_name }}</h4><br>
                <i>{{ comment.comment_timestamp.strftime("%m/%d/%y %X") }}</i><br>
                    <div data-linkify="this"><p>{{ comment.comment_text }}</p></div> <br>
                    {% if comment.comment_image %}
                    <img src="/{{ comment.comment_image }}" width="300"><br>
                    {% endif %}     
            </div>
            {% endfor %}
        </section>
      </div>
    </div>
    <div class = "col-xs-12 col-sm-12 col-md-3">
      <section>
              <h3>Users in this group are:</h3>
                <div class = "row">
                {% for group_user in group_users %}
                  <div class = "col-xs-6">          
                    <div class="pop-up">       
                      <h2>{{ group_user.first_name }} {{ group_user.last_name }}</h2>
                      <img src="/{{ group_user.user_photo }}" width="200">
                      <p data-linkify="this"> {{ group_user.user_descrip }}</p>
                      <button>close</button>
                    </div>
                    <div class = "show_user">
                    <img src="/{{ group_user.user_photo }}" width="50" class="img-circle" height="50">
                    <p> {{ group_user.first_name }} {{ group_user.last_name }}</p>
                    </div>
                  </div>  
                {% endfor %}
                <div class = "row">
                  <div class = "col-xs-12">
                    <h4><a href ="/invite_form/{{ group.group_id }}"> Invite people to join your group! </a></h4>
                  </div>
                </div>
      </section>
      <section>
          <h3>Latest tweets:</h3>
          <p>{{ group.hashtag}}</p>
          <div id="twitter" data-linkify="this"></div>
      </section>
      <section >
        
        <h3>Photo gallery:</h3>

        {% if comments|length > 0 %}
          {% if comments[0].comment_image %}
          <div> <img class ="feature" src="/{{ comments[0].comment_image }}" width="100%">

          <div id="container">
          {% endif %}
        {% endif %}
        {% for comment in comments %}
          {% if comment.comment_image %}
            <div>
            <img class = "tinypic" src="/{{ comment.comment_image }}" width="80px">
           </div>
          {% endif %}  
        {% endfor %}
      </div>
      </section>
    </div>
  </div>
</section>


{% block javascript %}
    
<script type="text/javascript">
var patternPoll
var voteConfirmation = "<br><h4 class='text-success' style='margin-left:15px;' >Thanks for voting! Your vote has been recorded</h4>"

$(document).ready(function(){
   $(".tinypic").click(function() {
                var new_image = $(this).attr("src");
                // var old_image = $('.feature').attr("src");
                console.log(new_image);
                $('.feature').attr("src", new_image);
                console.log($('.feature').attr("src"))
                $('.feature').fadeIn('slow');
            });

  $.get('/group_twitter.json/{{ group.group_id }}', function(results) {
        var keys = Object.keys(results);
        console.log(results);
        console.log(keys)
         console.log(keys.length)
        for(var i=0;i<keys.length;i++) {
            console.log(results[keys[i]].user_profile_pic)
            var twitter_div = "";
            twitter_div += "<b>"+ results[keys[i]].screen_name + "</b><br>";
            twitter_div += "<img src='" + results[keys[i]].user_profile_pic + "' width='50'>";
            twitter_div += "<i>" + results[keys[i]].text + "</i><br>";
            if(results[keys[i]].image_url) {
            twitter_div += "<img src='" + results[keys[i]].image_url + "' width='300'><br>";
            }
        $("#twitter").append(twitter_div);
        }
    })
  
  var options = { 
                responsive: true, 
                scaleShowGridLines : false,
                maintainAspectRatio: false,
                barValueSpacing : 50, 
                };
  var ctx_bar = $("#pattern_bar_graph").get(0).getContext("2d");

  $.get('/poll.json/{{ group.group_id }}', function(data) {
    patternPoll = new Chart(ctx_bar).Bar(data, options);
  });
  
  $.get('/flip_clock.json/{{ group.group_id}}', function(data) {
  seconds_left = data.seconds;
  

  var clock;
  
  clock = $('.clock').FlipClock({
        clockFace: 'DailyCounter',
        autoStart: false,
        callbacks: {
          stop: function() {
            $('.message').html('<h3> Voting has now ended. Please confirm the winning pattern. </h3>');
          }
        }
    });
    if (seconds_left > 1) {
      clock.setTime(seconds_left);
      if({{ votes }}.length=== {{ num_group_users }}) {
        if ({{ user }} == {{ group.admin_id }}) {
          $('#final_vote_confirm').show();
          $('.votes_complete').html('<h3> Everyone in your group has voted. Please confirm the winning pattern. </h3>')

       }
    }
    } else {
      clock.setTime(0);
      if ({{ user }} == {{ group.admin_id }}) {
        $('#final_vote_confirm').show();
      }
    }
    clock.setCountdown(true);
    clock.start();
    });

for(var i=0;i<{{votes}}.length;i++) {
    if({{ votes }}[i]==={{ user }} ){
      $('.pattern_select').hide();
      $( voteConfirmation ).insertAfter("#vote_form");
      $('#vote_submit').hide();
  }}

})

function handleVote(evt) {
  evt.preventDefault();

  var formInputs = {
    "group_id": $('#pattern_group').val(),
    "pattern_id":$('input[name=pattern_select]:checked', '#vote_form').val()
  };

  $.post('/update_poll.json', formInputs, function(data) {
    var dataLabels = patternPoll.datasets[0].bars;
    

    for (var i = 0; i < dataLabels.length; i++) {
      if (data.label === dataLabels[i].label) {
        patternPoll.datasets[0].bars[i].value = data.data; 
        patternPoll.update();
        } 
      }
    $('.pattern_select').hide();
    $( voteConfirmation ).insertAfter("#vote_form");
    $('#vote_submit').hide();
  })
}
$('#vote_form').on('submit', handleVote)

</script>

{% endblock %}
<script>
"use strict";
var options = {
      defaultProtocol: 'http',
      events: null,
      format: function (value, type) {
        return value;
      },
      formatHref: function (href, type) {
        return href;
      },
      linkAttributes: null,
      linkClass: null,
      nl2br: false,
      tagName: 'a',
      target: function (href, type) {
        return type === 'url' ? '_blank' : null;
      }
    };

$("#comment_form").submit(function(event){
  
  event.preventDefault();

    var formData = new FormData($('form#comment_form')[0]);
    

    $.ajax({
      url: '/comment_add.json',
      type: 'POST',
      data: formData,
      async: false,
      cache: false,
      contentType: false,
      processData: false,
      success: showComment,
      });
    
  });
  

    function showComment(results) {
    var htmlStr = "";
    htmlStr += "<img src='/" + results.comment_user_photo + "' width='50'>";
    htmlStr += "<h4>"+ results.comment_user_name + "</h4><br>"
    htmlStr += "<i>" + results.comment_timestamp + "</i><br>"
    htmlStr += "<p>" + results.comment_text + "</p><br>"
    if(results.comment_image) {
      htmlStr += "<img src='/" + results.comment_image + "' width='300'><br><br>";
    }

    $("#new_comment").prepend(htmlStr);
    $("#new_comment").linkify(options);
    $("#comment_text").val('');
    $("#comment_image").val('');
}
</script>

<script>
  function showUserInfo(evt) {
      $(this).prev('div.pop-up').css('z-index', 2);
      $(this).prev('div.pop-up').siblings('div').css('z-index', 1);
      $(this).prev('div.pop-up').show();
  }

  function hideUserInfo(evt) {
        $('div.pop-up').hide();
  }

  $('.show_user').click(showUserInfo);
  $('.pop-up').click(hideUserInfo);
    
</script>

<script>
  $('#container').freetile();
</script>


{% endblock %}